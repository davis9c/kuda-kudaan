<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Viewer 1728 Knight 5x5 Routes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #board {
            display: grid;
            grid-template-columns: repeat(5, var(--cell-size, 60px));
            grid-template-rows: repeat(5, var(--cell-size, 60px));
            gap: 4px;
        }

        .cell {
            width: var(--cell-size, 60px);
            height: var(--cell-size, 60px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            border-radius: 6px;
            transition: transform 120ms linear, box-shadow 120ms linear, opacity 160ms linear;
        }

        /* Board palette: dark and light greys for chessboard */
        .dark {
            background: #2f2f2f;
            /* dark grey */
            color: #ffffff;
        }

        .light {
            background: #e6e6e6;
            /* light grey */
            color: #111111;
        }

        .cell.highlight {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.12), 0 4px 12px rgba(0, 0, 0, 0.4);
            transform: scale(1.06);
        }

        .cell.trace {
            opacity: 0.85;
            filter: saturate(1.2) brightness(1.05);
            outline: 2px solid rgba(255, 255, 0, 0.08);
        }

        .cell.upcoming {
            opacity: 0.92;
            filter: saturate(0.9) brightness(0.98);
        }

        /* Mobile responsiveness */
        @media (max-width: 480px) {
            :root {
                --cell-size: 12vw;
            }

            /* make layout vertically centered and readable on phones */
            .container.py-4 {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .col-md-4 {
                order: 2;
                width: 100% !important;
                max-width: 480px;
            }

            .col-md-8 {
                order: 1;
                width: 100% !important;
                max-width: 480px;
            }

            .cell {
                font-size: 4.5vw;
            }

            #board {
                gap: 3px;
                margin: 0.6rem auto;
            }

            /* make controls easier to tap on small screens */
            .d-flex.gap-2 {
                gap: .5rem !important;
            }

            .btn {
                font-size: 16px;
                padding: .5rem 0.6rem;
            }

            .input-group .form-control {
                font-size: 16px;
            }

            #routeInfo {
                font-size: 13px;
                text-align: center;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            :root {
                --cell-size: 40px;
            }

            .cell {
                font-size: 16px;
            }
        }
    </style>
</head>

<body class="bg-dark text-light">

    <div class="container py-4">
        <h2 class="mb-4 text-warning">Viewer Rute Knight 5×5 (1728 Rute)</h2>

        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Pilih Nomor Rute:</label>
                <div class="d-flex mb-2 gap-2">
                    <button id="prevBtn" class="btn btn-sm btn-outline-light">◀</button>
                    <select id="routeSelect" class="form-select form-select-sm flex-grow-1"></select>
                    <button id="nextBtn" class="btn btn-sm btn-outline-light">▶</button>
                </div>

                <div class="input-group mb-2">
                    <span class="input-group-text">#</span>
                    <input id="routeNumberInput" type="number" class="form-control form-control-sm" min="1"
                        placeholder="Nomor rute">
                    <button id="goBtn" class="btn btn-sm btn-outline-light">Go</button>
                </div>

                <div class="d-flex align-items-center gap-2 mb-2">
                    <button id="playBtn" class="btn btn-sm btn-success">Play</button>
                    <button id="pauseBtn" class="btn btn-sm btn-secondary" disabled>Pause</button>
                    <button id="stopBtn" class="btn btn-sm btn-outline-light">Stop</button>
                    <button id="clearTraceBtn" class="btn btn-sm btn-outline-warning">Clear Trace</button>
                </div>

                <div class="mb-2">
                    <label class="form-label small mb-1">Speed:</label>
                    <input id="speedRange" type="range" min="50" max="1000" value="400">
                </div>

                <div class="mb-3 small text-muted" id="routeInfo">-</div>

                <div class="legend d-flex align-items-center small text-muted mb-3">
                    <span class="me-3" style="display:inline-flex;align-items:center;gap:8px">
                        <span
                            style="width:14px;height:14px;border-radius:3px;display:inline-block;background:rgba(255,159,28,0.9);border:1px solid rgba(0,0,0,0.12)"></span>
                        <span>Jejak — Sudah dilalui</span>
                    </span>
                    <span class="me-3" style="display:inline-flex;align-items:center;gap:8px">
                        <span
                            style="width:14px;height:14px;border-radius:3px;display:inline-block;background:#00d1ff;border:1px solid rgba(0,0,0,0.06)"></span>
                        <span>Animasi — Saat ini</span>
                    </span>
                    <span style="display:inline-flex;align-items:center;gap:8px">
                        <span
                            style="width:14px;height:14px;border-radius:3px;display:inline-block;background:rgba(0,209,255,0.12);border:1px solid rgba(0,0,0,0.04)"></span>
                        <span>Belum dilalui</span>
                    </span>
                </div>

            </div>

            <div class="col-md-8">
                <h5 class="text-info">Visualisasi Papan</h5>
                <div id="board"></div>
            </div>
        </div>
    </div>

    <script>
        let DATA = {};
        let ALL_ROUTES = []; // flattened list of all routes across groups
        let currentRouteIdx = 0;
        let isPlaying = false;
        let playTimer = null;
        let animationPos = 1;

        function loadJSON() {
            fetch("knight5x5_full_1728_matrix.json")
                .then(r => {
                    if (!r.ok) throw new Error('HTTP error ' + r.status);
                    return r.json();
                })
                .then(json => {
                    DATA = json;
                    ALL_ROUTES = [];

                    const isRoute = arr => Array.isArray(arr) && arr.length === 5 && arr.every(row => Array.isArray(row) && row.length === 5);

                    if (Array.isArray(json)) {
                        const looksLikeGroupOfRoutes = json.every(g => Array.isArray(g) && g.every(r => isRoute(r)));
                        if (looksLikeGroupOfRoutes) {
                            json.forEach((groupArr, gi) => {
                                const groupName = 'group_' + gi;
                                groupArr.forEach(route => ALL_ROUTES.push({ group: groupName, matrix: route }));
                            });
                        } else if (json.every(r => isRoute(r))) {
                            json.forEach((route, idx) => ALL_ROUTES.push({ group: 'all', matrix: route }));
                        } else {
                            json.forEach((item, i) => {
                                if (isRoute(item)) {
                                    ALL_ROUTES.push({ group: 'item_' + i, matrix: item });
                                } else if (Array.isArray(item)) {
                                    item.forEach((sub, j) => { if (isRoute(sub)) ALL_ROUTES.push({ group: 'item_' + i, matrix: sub }); });
                                }
                            });
                        }
                    } else if (typeof json === 'object' && json !== null) {
                        for (const grp in json) {
                            if (Array.isArray(json[grp]) && json[grp].every(r => isRoute(r))) {
                                json[grp].forEach(route => ALL_ROUTES.push({ group: grp, matrix: route }));
                            }
                        }
                    }

                    const routeSelect = document.getElementById("routeSelect");
                    routeSelect.innerHTML = "";

                    if (ALL_ROUTES.length === 0) {
                        routeSelect.disabled = true;
                        console.error('No routes found in JSON. Check JSON structure or file contents.');
                        alert('Tidak ada rute terdeteksi di file JSON. Lihat console untuk detail.');
                        return;
                    }

                    ALL_ROUTES.forEach((r, idx) => {
                        let opt = document.createElement("option");
                        opt.value = idx;
                        opt.textContent = "Rute #" + (idx + 1) + " (" + r.group + ")";
                        routeSelect.appendChild(opt);
                    });

                    // default to first route
                    selectRouteByIndex(0);
                    console.log("JSON Loaded, total routes:", ALL_ROUTES.length);
                })
                .catch(err => {
                    console.error('Failed to load JSON:', err);
                    alert('Gagal memuat JSON: ' + err + '\nJika membuka file langsung (file://), coba jalankan server HTTP lokal seperti `python -m http.server` di folder proyek.');
                });
        }

        function renderBoard(matrix) {
            const board = document.getElementById("board");
            board.innerHTML = "";

            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    let cell = document.createElement("div");
                    cell.classList.add("cell");
                    cell.classList.add((r + c) % 2 === 0 ? "dark" : "light");
                    const num = matrix[r][c];
                    cell.textContent = num;
                    // store row/col and number for animation
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.dataset.num = num;
                    // make sure inline styles are clean when rendering
                    cell.style.background = '';
                    cell.style.color = '';
                    cell.classList.remove('trace', 'highlight');
                    board.appendChild(cell);
                }
            }
            // clear any previous highlights/traces
            clearHighlights();
        }

        function clearHighlights() {
            document.querySelectorAll('.cell.highlight').forEach(n => {
                n.classList.remove('highlight');
                n.style.background = '';
            });
        }

        function clearTrace() {
            document.querySelectorAll('.cell.trace, .cell.upcoming').forEach(n => {
                n.classList.remove('trace', 'upcoming');
                n.style.background = '';
                n.style.color = '';
            });
        }

        function colorForStep(i, total) {
            // Fixed two-color palette: cyan for animation highlight, orange for trace (jejak)
            const HIGHLIGHT = '#00d1ff'; // bright cyan
            const TRACE = 'rgba(255,159,28,0.36)'; // translucent orange
            const UPCOMING = 'rgba(0,209,255,0.10)'; // very faint cyan for upcoming
            return {
                highlight: HIGHLIGHT,
                trace: TRACE,
                upcoming: UPCOMING
            };
        }

        function getReadableTextColor(hslString) {
            // naive luminance check: parse the lightness from hsl(...) and choose black/white text
            // handle formats: hex (#rrggbb), rgb(a), hsl(a)
            try {
                if (!hslString) return '#fff';
                hslString = hslString.trim();
                if (hslString.startsWith('hsl')) {
                    const m = hslString.match(/hsl\((\d+),\s*(\d+)%?,\s*(\d+)%?\)/);
                    if (m) return (parseInt(m[3], 10) < 55) ? '#fff' : '#000';
                }
                if (hslString.startsWith('#')) {
                    const hex = hslString.slice(1);
                    const r = parseInt(hex.substring(0, 2), 16);
                    const g = parseInt(hex.substring(2, 4), 16);
                    const b = parseInt(hex.substring(4, 6), 16);
                    // relative luminance
                    const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
                    return lum > 0.6 ? '#000' : '#fff';
                }
                if (hslString.startsWith('rgb')) {
                    const m = hslString.match(/rgba?\(([^)]+)\)/);
                    if (m) {
                        const parts = m[1].split(',').map(p => parseFloat(p));
                        const r = parts[0], g = parts[1], b = parts[2];
                        const lum = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
                        return lum > 0.6 ? '#000' : '#fff';
                    }
                }
            } catch (e) { }
            return '#fff';
        }

        function selectRouteByIndex(idx) {
            if (!ALL_ROUTES.length) return;
            if (idx < 0) idx = ALL_ROUTES.length - 1;
            if (idx >= ALL_ROUTES.length) idx = 0;
            currentRouteIdx = idx;
            const routeSelect = document.getElementById('routeSelect');
            routeSelect.value = idx;
            const info = document.getElementById('routeInfo');
            info.textContent = `Rute ${idx + 1} / ${ALL_ROUTES.length} — group: ${ALL_ROUTES[idx].group}`;
            document.getElementById('routeNumberInput').value = idx + 1;
            stopAnimation();
            clearHighlights();
            renderBoard(ALL_ROUTES[idx].matrix);
            // mark upcoming/future steps with faded color so user sees which cells are in the route
            const { map, nums } = buildPositions(ALL_ROUTES[idx].matrix);
            nums.forEach((n, i) => {
                if (map[n]) {
                    const colors = colorForStep(i, nums.length);
                    map[n].classList.add('upcoming');
                    map[n].style.background = colors.upcoming;
                    // choose readable text color if needed
                    map[n].style.color = getReadableTextColor(colors.upcoming);
                }
            });
        }

        function buildPositions(matrix) {
            // returns a map number -> cell element (1..25), if numbers may not be 1..25 we collect sorted numeric keys
            const map = {};
            document.querySelectorAll('#board .cell').forEach(cell => {
                const n = parseInt(cell.dataset.num);
                if (!isNaN(n)) map[n] = cell;
            });
            // get sorted keys
            const nums = Object.keys(map).map(n => parseInt(n)).sort((a, b) => a - b);
            return { map, nums };
        }

        function playAnimation() {
            if (isPlaying) return;
            const speed = parseInt(document.getElementById('speedRange').value) || 400;
            const { map, nums } = buildPositions(ALL_ROUTES[currentRouteIdx].matrix);
            if (!nums || nums.length === 0) return;
            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            animationPos = 0;

            playTimer = setInterval(() => {
                if (animationPos > 0) {
                    // mark previous as trace with color
                    const prevNum = nums[animationPos - 1];
                    if (map[prevNum]) {
                        const colors = colorForStep(animationPos - 1, nums.length);
                        map[prevNum].style.background = colors.trace;
                        map[prevNum].classList.add('trace');
                        map[prevNum].classList.remove('upcoming');
                    }
                }
                if (animationPos >= nums.length) {
                    stopAnimation();
                    return;
                }
                // remove highlight from all, then highlight current with color
                clearHighlights();
                const curNum = nums[animationPos];
                if (map[curNum]) {
                    const colors = colorForStep(animationPos, nums.length);
                    map[curNum].style.background = colors.highlight;
                    map[curNum].classList.add('highlight');
                    map[curNum].classList.remove('upcoming');
                    // ensure text remains readable
                    map[curNum].style.color = getReadableTextColor(colors.highlight);
                }
                animationPos++;
            }, speed);
        }

        function pauseAnimation() {
            if (!isPlaying) return;
            clearInterval(playTimer);
            playTimer = null;
            isPlaying = false;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function stopAnimation() {
            if (playTimer) clearInterval(playTimer);
            playTimer = null;
            isPlaying = false;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            clearHighlights();
        }

        // wire up controls
        document.addEventListener('click', (ev) => {
            // nothing here now
        });

        document.getElementById('routeSelect').addEventListener('change', function () {
            const idx = parseInt(this.value);
            if (isNaN(idx) || !ALL_ROUTES[idx]) return;
            selectRouteByIndex(idx);
        });

        document.getElementById('prevBtn').addEventListener('click', () => selectRouteByIndex(currentRouteIdx - 1));
        document.getElementById('nextBtn').addEventListener('click', () => selectRouteByIndex(currentRouteIdx + 1));

        document.getElementById('goBtn').addEventListener('click', () => {
            const v = parseInt(document.getElementById('routeNumberInput').value);
            if (isNaN(v)) return;
            selectRouteByIndex(v - 1);
        });

        document.getElementById('routeNumberInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const v = parseInt(e.target.value);
                if (!isNaN(v)) selectRouteByIndex(v - 1);
            }
        });

        document.getElementById('playBtn').addEventListener('click', () => playAnimation());
        document.getElementById('pauseBtn').addEventListener('click', () => pauseAnimation());
        document.getElementById('stopBtn').addEventListener('click', () => stopAnimation());
        document.getElementById('clearTraceBtn').addEventListener('click', () => clearTrace());

        // when speed changes, if playing restart interval with new speed
        document.getElementById('speedRange').addEventListener('input', () => {
            if (isPlaying) {
                pauseAnimation();
                playAnimation();
            }
        });

        // init
        loadJSON();
    </script>

</body>

</html>